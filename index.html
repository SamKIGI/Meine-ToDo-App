
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>KI To-Do – Smart & Modern</title>
<style>
  :root {
    --bg: #f5f7fb; --panel: #ffffff; --card: #ffffff; --muted: #f0f3f8;
    --text: #0f172a; --sub: #475569; --accent: #4f46e5; --accent-2: #818cf8;
    --ok: #10b981; --warn: #f59e0b; --bad: #ef4444;
    --border: #e2e8f0; --shadow: 0 10px 30px rgba(15,23,42,.08), 0 1px 0 rgba(15,23,42,.04);
    --radius: 16px;
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body { margin: 0; background: linear-gradient(180deg, #f8fafc 0%, #eef2f7 100%); color: var(--text); font: 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  .app { max-width: 1400px; margin: 0 auto; padding: 22px; }
  header { display: flex; gap: 12px; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; }
  .brand { display: flex; align-items: center; gap: 12px; }
  .logo { width: 30px; height: 30px; border-radius: 10px; background: conic-gradient(from 180deg at 50% 50%, #818cf8, #a78bfa, #34d399, #818cf8); box-shadow: 0 6px 18px rgba(99,102,241,.25); }
  .title { font-weight: 800; letter-spacing: .2px; }
  .toolbar { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; flex-grow: 1; justify-content: flex-end; }
  .ai-toolbar { width: 100%; display: flex; gap: 8px; margin-top: 8px; }
  button, .btn {
    background: var(--panel); color: var(--text); border: 1px solid var(--border);
    padding: 10px 12px; border-radius: 12px; cursor: pointer; transition: .18s; box-shadow: var(--shadow);
    display: inline-flex; align-items: center; gap: 6px; white-space: nowrap;
  }
  button:hover { transform: translateY(-1px); background: var(--muted); }
  button:disabled { cursor: not-allowed; opacity: 0.6; }
  .primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #fff; border: 0; }
  .segmented { display: flex; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: var(--panel); box-shadow: var(--shadow); }
  .segmented button { border: 0; background: transparent; box-shadow: none; border-radius: 0; }
  .segmented button.active { background: var(--accent); color: #fff; }
  .input, select, textarea {
    background: var(--panel); border: 1px solid var(--border); color: var(--text);
    padding: 10px 12px; border-radius: 12px; outline: none; transition: .18s; width: 100%; box-shadow: var(--shadow);
  }
  .input:focus { border-color: var(--accent); }
  .search { min-width: 200px; }
  .switch { display: flex; align-items: center; gap: 8px; }
  .content { display: grid; gap: 14px; }
  /* Boards (Listen) */
  .board { display: grid; grid-template-columns: repeat(auto-fill,minmax(300px,1fr)); gap: 14px; }
  .column { background: var(--panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 12px; box-shadow: var(--shadow); }
  .column.collapsed .tasks { display: none; }
  .column .head { display: flex; align-items: center; justify-content: space-between; gap: 8px; margin-bottom: 6px; }
  .column .head .header-actions { display: flex; gap: 4px; }
  .count { color: var(--sub); font-size: 12px; }
  .tasks { min-height: 40px; }
  .task { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 10px; margin: 8px 0; display: flex; flex-direction: column; gap: 8px; box-shadow: var(--shadow); }
  .task.dragging { opacity: .6; }
  .task .row { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .task .actions { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 8px; }
  .badge { font-size: 12px; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border); background: var(--muted); color: var(--sub); white-space: nowrap; }
  .pri-high { background: #fee2e2; color: #7f1d1d; border: 0; }
  .pri-mid { background: #fef3c7; color: #7c2d12; border: 0; }
  .pri-low { background: #dcfce7; color: #064e3b; border: 0; }
  .ampel { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 6px; vertical-align: -1px; }
  .ampel.green { background: var(--ok); }
  .ampel.yellow { background: var(--warn); }
  .ampel.red { background: var(--bad); }
  .meta { color: var(--sub); font-size: 12px; display: flex; gap: 8px; flex-wrap: wrap; }
  .chips { display: flex; gap: 6px; flex-wrap: wrap; }
  /* Progress bar */
  .progress { height: 8px; background: var(--muted); border-radius: 999px; overflow: hidden; border: 1px solid var(--border); }
  .progress > div { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); width: 0%; }
  /* Calendar View with KW column */
  .cal { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 10px; box-shadow: var(--shadow); }
  .cal-grid { display: grid; grid-template-columns: 60px repeat(7,1fr); gap: 6px; align-items: stretch; }
  .cal-kw { display: flex; align-items: center; justify-content: center; border: 1px solid var(--border); border-radius: 10px; background: #f8fafc; color: #334155; font-weight: 600; }
  .cal-cell { border: 1px solid var(--border); min-height: 90px; border-radius: 10px; padding: 6px; background: var(--card); position: relative; }
  .cal-cell .d { position: absolute; top: 6px; right: 8px; color: var(--sub); font-size: 12px; }
  .chip { display: inline-flex; align-items: center; gap: 6px; padding: 3px 8px; border-radius: 999px; border: 1px solid var(--border); background: var(--muted); font-size: 11px; margin: 2px 0; cursor: pointer; }
  .chip:hover { background: var(--border); }
  /* Modal */
  .modal-back { position: fixed; inset: 0; background: rgba(15,23,42,.35); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; padding: 16px; z-index: 10; }
  .modal { background: var(--panel); border: 1px solid var(--border); border-radius: 18px; max-width: 820px; width: 100%; box-shadow: var(--shadow); position: relative; }
  .modal header { padding: 14px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
  .modal main { padding: 14px; display: grid; gap: 12px; max-height: 70vh; overflow-y: auto; }
  .modal footer { padding: 12px; border-top: 1px solid var(--border); display: flex; justify-content: space-between; gap: 8px; }
  #modal main { grid-template-columns: 1fr 1fr; }
  .modal .header-actions { display: flex; align-items: center; gap: 8px; }
  .close-btn { background: transparent; border: 0; box-shadow: none; font-size: 24px; cursor: pointer; padding: 4px 10px; color: var(--sub); line-height: 1; }
  .close-btn:hover { color: var(--text); }
  .row-span-2 { grid-row: span 2; }
  .full { grid-column: 1 / -1; }
  .label-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .input-group { display: flex; gap: 6px; align-items: center; }
  .input-group .input { flex-grow: 1; }
  .input-group button { padding: 8px; }
  /* Reschedule Modal Specifics */
  #rescheduleSuggestions > div { padding: 10px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
  #rescheduleSuggestions > div:hover { background-color: var(--muted); }
  /* Calendar Detail View */
  #calDetailModal .detail-grid { display: grid; grid-template-columns: 100px 1fr; gap: 8px 14px; align-items: center; }
  #calDetailModal .detail-grid strong { color: var(--sub); text-align: right; }
  #calDetailModal .detail-grid .detail-note { grid-column: 1 / -1; white-space: pre-wrap; background: var(--muted); padding: 10px; border-radius: 10px; }
  #calDetailModal .detail-grid .detail-subs { grid-column: 1 / -1; }
  /* Management Modal */
  #manageModal main { display: flex; gap: 20px; }
  #manageModal section { flex: 1; }
  .manage-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-radius: 8px; }
  .manage-item:hover { background: var(--muted); }
  .manage-item .actions { display: flex; gap: 4px; }
  .manage-item .actions button { padding: 4px 8px; font-size: 14px; line-height: 1; border-radius: 6px; }
  /* Toast */
  .toast { position: fixed; left: 50%; transform: translateX(-50%); bottom: 18px; background: var(--card); border: 1px solid var(--border); padding: 10px 14px; border-radius: 12px; display: none; gap: 10px; align-items: center; box-shadow: var(--shadow); z-index: 20; }
  .spinner {
    width: 16px; height: 16px; border: 2px solid currentColor;
    border-right-color: transparent; border-radius: 50%;
    animation: spinner-anim .7s linear infinite;
  }
  @keyframes spinner-anim { to { transform: rotate(360deg); } }
  .hidden { display: none !important; }
  #briefingContent { white-space: pre-wrap; line-height: 1.6; max-height: 70vh; overflow-y: auto; display: block; }
  @media (max-width: 820px) {
    #modal main, #manageModal main { grid-template-columns: 1fr; flex-direction: column; }
    .board { grid-template-columns: 1fr; }
    .search { min-width: 0; flex: 1; }
    .cal-grid { grid-template-columns: 50px repeat(7,1fr); }
  }
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo"></div>
      <div class="title">KI To-Do</div>
    </div>
    <div class="toolbar">
      <input id="q" class="input search" placeholder="Suchen…">
      <div class="segmented" id="viewTabs">
        <button data-view="board" class="active">Listen</button>
        <button data-view="cal">Kalender</button>
      </div>
      <div class="switch"><input type="checkbox" id="onlyOpen"><label for="onlyOpen">Nur offene</label></div>
      <div class="switch"><input type="checkbox" id="showClosedLists"><label for="showClosedLists">Fertige Listen</label></div>
      <select id="projectFilter" class="input" style="width:160px;"><option value="">Alle Projekte</option></select>
      <select id="listFilter" class="input" style="width:160px;"><option value="">Alle Listen</option></select>
      
      <button id="aiBriefingBtn" title="Tages-Briefing">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
      </button>

      <!-- REMOVED: Tagesabschluss-Button wurde auf Wunsch entfernt -->

      <button id="manageBtn" title="Listen & Projekte verwalten">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l-.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
      </button>

      <button id="addBtn" class="primary">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
      </button>

      <button id="setApiKeyBtn" title="API-Schlüssel">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9a2 2 0 0 1-2 2H6l-4 4V4c0-1.1.9-2 2-2h8a2 2 0 0 1 2 2v5Z"></path><path d="M18 9h2a2 2 0 0 1 2 2v11l-4-4h-6a2 2 0 0 1-2-2v-1"></path></svg>
      </button>
    </div>
    <div class="ai-toolbar">
        <input id="aiTaskInput" class="input" placeholder="✨ Aufgabe mit KI erstellen (z.B. 'Nächsten Dienstag Meeting mit Marketing planen')">
        <button id="aiTaskBtn" class="primary">Erstellen</button>
    </div>
  </header>

  <div id="boardView" class="content">
    <div id="board" class="board"></div>
  </div>

  <div id="calView" class="content" style="display:none">
    <div class="kw-bar" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
      <label>Monat:</label>
      <select id="calMonth" class="input" style="width:160px"></select>
      <label>Jahr:</label>
      <input id="calYear" class="input" type="number" min="1970" max="2099" style="width:120px">
      <button id="calToday">Heute</button>
    </div>
    <div class="cal" style="margin-top:8px">
      <div class="cal-grid" id="calGrid"></div>
    </div>
  </div>
</div>

<div class="modal-back" id="modalBack">
  <div class="modal" role="dialog" aria-modal="true">
    <header>
        <strong id="modalTitle">Neue Aufgabe</strong>
        <div class="header-actions">
            <button id="aiCategoryBtn" title="Liste & Projekt vorschlagen">
                <span class="spinner hidden"></span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 4.2-4.3.6 3.1 3- .7 4.2 3.8-2 3.8 2-.7-4.2 3.1-3-4.3-.6z"/></svg>
                Kategorisieren
            </button>
            <button class="close-btn" id="closeModalBtn" title="Schließen">&times;</button>
        </div>
    </header>
    <main>
      <div class="full">
        <label>Titel<br><input id="f_title" class="input" placeholder="Was ist zu tun?"></label>
      </div>
      <div>
        <label>Fällig am<br><input id="f_due" class="input" type="date"></label>
      </div>
      <div>
        <label>Uhrzeit<br><input id="f_time" class="input" type="time" placeholder="HH:MM"></label>
      </div>
      <div>
        <label>Ort<br><input id="f_loc" class="input" placeholder="Ort / Standort"></label>
      </div>
      <div>
        <label>Priorität</label>
        <div class="input-group">
          <select id="f_pri" class="input">
            <option value="mid">Mittel</option>
            <option value="high">Hoch</option>
            <option value="low">Niedrig</option>
          </select>
          <button id="aiPriorityBtn" title="Priorität vorschlagen">
            <span class="spinner hidden"></span>
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 4.2-4.3.6 3.1 3- .7 4.2 3.8-2 3.8 2-.7-4.2 3.1-3-4.3-.6z"/></svg>
          </button>
        </div>
      </div>
      <div>
        <label>Liste</label>
        <div class="input-group">
          <select id="f_list" class="input"></select>
        </div>
        <div id="newListWrap" style="margin-top:6px; display:none">
          <input id="f_list_new" class="input" placeholder="Neue Liste">
        </div>
      </div>
      <div>
        <label>Projekt</label>
        <div class="input-group">
          <select id="f_project" class="input"></select>
        </div>
        <div id="newProjectWrap" style="margin-top:6px; display:none">
          <input id="f_project_new" class="input" placeholder="Neues Projekt">
        </div>
      </div>
      <div class="row-span-2">
        <div class="label-group">
            <label for="f_subs">Checkliste</label>
            <button id="aiSubtaskBtn">
                <span class="spinner hidden"></span>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3c.3 0 .5.1.8.4l.2.2c.4.4.5.9.5 1.4v2c0 .6-.2 1.1-.5 1.5l-.2.2c-.3.3-.5.4-.8.4s-.5-.1-.8-.4l-.2-.2c-.4-.4-.5-.9-.5-1.5v-2c0-.5.1-1 .5-1.4l.2-.2c.3-.3.5-.4.8-.4z"/><path d="M3.5 10.5c.3 0 .5.1.8.4l.2.2c.4.4.5.9.5 1.4v2c0 .6-.2 1.1-.5 1.5l-.2.2c-.3.3-.5.4-.8.4s-.5-.1-.8-.4l-.2-.2c-.4-.4-.5-.9-.5-1.5v-2c0-.5.1-1 .5-1.4l.2-.2c.3-.3.5-.4.8-.4z"/><path d="M20.5 10.5c.3 0 .5.1.8.4l.2.2c.4.4.5.9.5 1.4v2c0 .6-.2 1.1-.5 1.5l-.2.2c-.3.3-.5.4-.8.4s-.5-.1-.8-.4l-.2-.2c-.4-.4-.5-.9-.5-1.5v-2c0-.5.1-1 .5-1.4l.2-.2c.3-.3.5-.4.8-.4z"/></svg>
                Vorschlagen
            </button>
        </div>
        <textarea id="f_subs" class="input" rows="6" placeholder="- Punkt 1&#10;- Punkt 2&#10;…"></textarea>
      </div>
      <div class="full">
        <label>Notiz<br><textarea id="f_note" class="input" rows="3" placeholder="Details, Hinweise (lokal)"></textarea></label>
      </div>
    </main>
    <footer>
      <div style="display:flex;gap:8px">
        <button id="cancelBtn">Abbrechen</button>
      </div>
      <div style="display:flex;gap:8px">
        <button id="saveBtn" class="primary">Speichern</button>
      </div>
    </footer>
  </div>
</div>

<div class="modal-back" id="briefingModalBack">
  <div class="modal" role="dialog" aria-modal="true">
    <header><strong id="briefingTitle">Ihr Tages-Briefing</strong> <button id="closeBriefingBtn" class="close-btn">&times;</button></header>
    <main id="briefingContent"></main>
  </div>
</div>

<div class="modal-back" id="rescheduleModalBack">
    <div class="modal" role="dialog" aria-modal="true">
        <header><strong>Termin neu planen</strong> <button id="closeRescheduleBtn" class="close-btn">&times;</button></header>
        <main>
            <div class="full" id="rescheduleTaskTitle" style="font-weight: bold; margin-bottom: 12px;"></div>
            <div class="full" id="rescheduleSuggestions">
                <div style="display:flex; justify-content:center; padding: 40px;"><span class="spinner"></span></div>
            </div>
        </main>
    </div>
</div>

<div class="modal-back" id="calDetailModalBack">
    <div class="modal" id="calDetailModal" role="dialog" aria-modal="true">
        <header><strong>Aufgabendetails</strong> <button id="calDetailCloseBtn" class="close-btn">&times;</button></header>
        <main id="calDetailContent" class="detail-grid" style="grid-template-columns: 1fr;"></main>
        <footer style="justify-content:flex-end">
            <button id="calDetailEditBtn" class="primary">Bearbeiten</button>
        </footer>
    </div>
</div>

<div class="modal-back" id="manageModalBack">
    <div class="modal" id="manageModal" role="dialog" aria-modal="true">
        <header><strong>Listen & Projekte verwalten</strong> <button id="manageCloseBtn" class="close-btn">&times;</button></header>
        <main>
            <section>
                <h3>Listen</h3>
                <div id="manageListsContainer"></div>
            </section>
            <section>
                <h3>Projekte</h3>
                <div id="manageProjectsContainer"></div>
            </section>
        </main>
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
// This script contains the entire application logic for the To-Do list.
// It handles data storage, rendering, user interactions, and the new AI features.

/* ========== Utilities ========== */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const uid = () => 't_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
const clamp = (n,a,b)=>Math.max(a,Math.min(b,n));

const todayStr = () => {
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
  const dd = String(today.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
};

const formatDate = (d,t, opts={}) => {
  if(!d) return '—';
  const [hh,mm] = (t||'23:59').split(':').map(x=>parseInt(x||0,10));
  const dt = new Date(d+'T'+String(hh).padStart(2,'0')+':'+String(mm).padStart(2,'0')+':00');
  const defaultOpts = {weekday:'short',day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'};
  return dt.toLocaleString('de-DE',{...defaultOpts, ...opts});
};
function ampelClass(due, time) {
    if (!due) return 'green';
    const now = new Date();
    const dueDateTime = new Date(`${due}T${time || '23:59:59'}`);
    if (dueDateTime < now) return 'red';
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const dueDay = new Date(dueDateTime.getFullYear(), dueDateTime.getMonth(), dueDateTime.getDate());
    const diffDays = (dueDay.getTime() - today.getTime()) / (1000 * 3600 * 24);
    if (diffDays < 1) return 'yellow';
    return 'green';
}
function isoWeek(date){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = (d.getUTCDay() + 6) % 7; // Mon=0
  d.setUTCDate(d.getUTCDate() - dayNum + 3);
  const firstThursday = new Date(Date.UTC(d.getUTCFullYear(),0,4));
  const weekNum = 1 + Math.round(((d - firstThursday) / 86400000 - 3 + ((firstThursday.getUTCDay()+6)%7)) / 7);
  return {year:d.getUTCFullYear(), week:weekNum};
}
function monthMatrix(year, monthIdx){
  const first = new Date(year,monthIdx,1);
  const start = new Date(first);
  start.setDate(1 - ((first.getDay()+6)%7));
  const days = Array.from({length:42},(_,i)=>new Date(start.getFullYear(),start.getMonth(),start.getDate()+i));
  const kw = [];
  for(let r=0;r<6;r++){ const monday = days[r*7]; kw.push(isoWeek(monday).week); }
  return {days, kw};
}

/* ========== Storage (IndexedDB v4) ========== */
const DB_NAME='todoDB_v4', STORE='tasks', META='meta';
let db=null;

function idbOpen(){
  return new Promise((resolve)=>{
    const req = indexedDB.open(DB_NAME,4);
    req.onupgradeneeded = e => {
      const db=e.target.result;
      if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE,{keyPath:'id'}).createIndex('due','due',{unique:false});
      if(!db.objectStoreNames.contains(META)) db.createObjectStore(META,{keyPath:'key'});
    };
    req.onsuccess = e => { db=e.target.result; resolve(); };
    req.onerror = () => { console.error("DB Error"); resolve(); };
  });
}
function idbAll(){ return new Promise((resolve)=>{ db.transaction(STORE,'readonly').objectStore(STORE).getAll().onsuccess=e=>resolve(e.target.result||[]); }); }
function idbPut(item){ return new Promise((resolve)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(item); tx.oncomplete=resolve; }); }
async function idbBulkPut(items) {
    if (!items || items.length === 0) return Promise.resolve();
    return new Promise((resolve, reject) => {
        const tx = db.transaction(STORE, 'readwrite');
        items.forEach(item => tx.objectStore(STORE).put(item));
        tx.oncomplete = resolve;
        tx.onerror = reject;
    });
}
function idbDelete(id){ return new Promise((resolve)=>{ const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).delete(id); tx.oncomplete=resolve; }); }
function metaGet(key, defVal){ return new Promise((resolve)=>{ db.transaction(META,'readonly').objectStore(META).get(key).onsuccess=e=>resolve(e.target.result||{key,value:defVal}); }); }
function metaPut(key, value){ return new Promise((resolve)=>{ const tx=db.transaction(META,'readwrite'); tx.objectStore(META).put({key,value}); tx.oncomplete=resolve; }); }

/* ========== Gemini AI Integration ========== */
const AI = {
    apiKey: null,
    async loadApiKey() { this.apiKey = (await metaGet('geminiApiKey', null)).value; return this.apiKey; },
    async saveApiKey(key) { this.apiKey = key; await metaPut('geminiApiKey', key); },
    async getApiKey() {
        if (!this.apiKey) await this.loadApiKey();
        if (!this.apiKey) {
            const key = prompt('Bitte geben Sie Ihren Google Gemini API-Schlüssel ein.', '');
            if (key) await this.saveApiKey(key); else { showToast('API-Schlüssel wird für KI-Funktionen benötigt.'); return null; }
        }
        return this.apiKey;
    },
    async call(prompt, isJson = false) {
        const key = await this.getApiKey();
        if (!key) return null;
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${key}`;
        let payload = { contents: [{ parts: [{ text: prompt }] }] };
        if (isJson) payload.generationConfig = { responseMimeType: "application/json" };
        try {
            const response = await fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                const error = await response.json(); console.error('Gemini API Error:', error);
                showToast(`API Fehler: ${error.error?.message || response.statusText}`); return null;
            }
            const data = await response.json();
            const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            if (!text) return null;
            const sanitizedText = text.replace(/^```(json)?\s*|```\s*$/g, '');
            return isJson ? JSON.parse(sanitizedText) : sanitizedText;
        } catch (error) {
            console.error('Fetch Error:', error); showToast('Netzwerkfehler oder ungültige API-Antwort.'); return null;
        }
    }
};

/* ========== App State & Helpers ========== */
let STATE = { tasks: [], projects: [], lists: [], filter:{ q:'', onlyOpen:true, showClosedLists:false, project:'', list:'' }, view:'board' };
let lastDeleted=null;
const isListCompleted = (tasks) => tasks.length > 0 && tasks.every(t=> (t.subs?.length ? t.subs.every(s=>s.done) : t.done));

/* ========== Filters & Sorting ========== */
function applyFilters(ignoreOpenFilter = false){
  let arr=[...STATE.tasks];
  const q=STATE.filter.q.toLowerCase().trim();
  if(q) arr = arr.filter(t => [t.title, t.loc, t.note, t.list, t.project].some(f => (f||'').toLowerCase().includes(q)));
  if(STATE.filter.onlyOpen && !ignoreOpenFilter) arr = arr.filter(t => !(t.subs?.length ? t.subs.every(s=>s.done) : t.done));
  if(STATE.filter.project) arr = arr.filter(t => (t.project||'')===STATE.filter.project);
  if(STATE.filter.list) arr = arr.filter(t => (t.list||'Allgemein')===STATE.filter.list);
  const priRank = {high:0, mid:1, low:2};
  arr.sort((a,b)=>{
    if((a.list||'Allgemein') !== (b.list||'Allgemein')) return (a.list||'Allgemein').localeCompare(b.list||'Allgemein');
    const ai = a.sortIndex ?? 999, bi = b.sortIndex ?? 999; if(ai!==bi) return ai-bi;
    const ad=(a.due||'9999')+(a.time||'2359'), bd=(b.due||'9999')+(b.time||'2359'); if(ad!==bd) return ad<bd ? -1 : 1;
    return priRank[a.pri]-priRank[b.pri];
  });
  return arr;
}

/* ========== Drag & Drop ========== */
function enableDnDForCard(card, task){
  card.setAttribute('draggable','true');
  card.addEventListener('dragstart', (e)=>{ e.dataTransfer.setData('text/plain', task.id); card.classList.add('dragging'); });
  card.addEventListener('dragend', ()=> card.classList.remove('dragging'));
}
function enableDnDForContainer(container, listName){
  container.addEventListener('dragover', (e)=> e.preventDefault());
  container.addEventListener('drop', async (e)=>{
    e.preventDefault();
    const id = e.dataTransfer.getData('text/plain');
    const t = STATE.tasks.find(x=>x.id===id);
    if(t) {
      t.list = listName;
      t.sortIndex = (STATE.tasks.filter(x=> (x.list||'Allgemein')===listName).reduce((m,x)=> Math.max(m, x.sortIndex ?? -1), -1)) + 1;
      await idbPut(t); upsertLocal(t); scheduleRender();
      await maybeAddList(listName);
    }
  });
}

/* ========== Renderers ========== */
function renderBoard(){
  const root = $('#board'); root.innerHTML='';
  const tasks = applyFilters();
  const groups = {};
  tasks.forEach(t => { const key = t.list || 'Allgemein'; if (!groups[key]) groups[key] = []; groups[key].push(t); });
  
  Object.keys(groups).sort().forEach(listName => {
    const listTasks = groups[listName];
    const completed = isListCompleted(listTasks);
    if(completed && !STATE.filter.showClosedLists) return;
    normalizeSort(listTasks);
    const col = document.createElement('div'); col.className='column' + (completed?' collapsed':'');
    col.innerHTML = `
      <div class="head">
        <div><strong>${escapeHtml(listName)}</strong> <span class="count">(${listTasks.length})</span></div>
        <div class="header-actions">
          <button class="smart-sort-btn" title="Liste smart sortieren"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 4.2-4.3.6 3.1 3- .7 4.2 3.8-2 3.8 2-.7-4.2 3.1-3-4.3-.6z"/></svg></button>
          <button class="toggle-btn">${completed?'Anzeigen':'Zuklappen'}</button>
        </div>
      </div>
      <div class="tasks"></div>`;
    const tasksContainer = col.querySelector('.tasks');
    listTasks.forEach(t=> tasksContainer.appendChild(taskCard(t)));
    enableDnDForContainer(tasksContainer, listName);
    col.querySelector('.smart-sort-btn').onclick = async (e) => {
        const btn = e.currentTarget; btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>';
        await handleAiSmartSort(listName);
        btn.disabled = false; btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.9 4.2-4.3.6 3.1 3- .7 4.2 3.8-2 3.8 2-.7-4.2 3.1-3-4.3-.6z"/></svg>`;
    };
    col.querySelector('.toggle-btn').onclick=()=> col.classList.toggle('collapsed');
    root.appendChild(col);
  });
}

function normalizeSort(listTasks){ if(listTasks.some(t=> t.sortIndex==null)) listTasks.forEach((t,i)=>{ if(t.sortIndex==null) t.sortIndex = i; }); }

function taskCard(t){
  const card=document.createElement('div'); card.className='task'; card.id = t.id;
  const {done,total} = t.subs?.length ? {done: t.subs.filter(s=>s.done).length, total: t.subs.length} : {done: t.done?1:0, total: 1};
  const pct = total===0 ? (t.done?100:0) : Math.round((done/total)*100);
  const isDone = pct === 100;
  card.innerHTML = `
    <div class="row">
      <div><span class="ampel ${isDone ? 'green' : ampelClass(t.due, t.time)}"></span><strong>${escapeHtml(t.title||'(ohne Titel)')}</strong></div>
      <span class="badge ${t.pri==='high'?'pri-high':t.pri==='low'?'pri-low':'pri-mid'}">${t.pri==='high'?'Hoch':t.pri==='low'?'Niedrig':'Mittel'}</span>
    </div>
    <div class="meta chips">
      ${t.due ? `<span class="badge">${formatDate(t.due, t.time)}</span>` : ''}
      ${t.due ? `<span class="badge">KW ${isoWeek(new Date(t.due+'T00:00:00')).week}</span>` : ''}
      ${t.loc ? `<span class="badge">📍 ${escapeHtml(t.loc)}</span>` : ''}
      ${t.project ? `<span class="badge">🗂️ ${escapeHtml(t.project)}</span>` : ''}
    </div>
    <div class="progress"><div style="width:${pct}%"></div></div>
    ${t.subs?.length ? `<div class="subtasks">${t.subs.map((s, idx) => `<label class="subitem"><input type="checkbox" data-idx="${idx}" ${s.done ? 'checked' : ''}><span>${escapeHtml(s.text)}</span></label>`).join('')}<div class="text-muted" style="margin-top:6px">${done}/${total} erledigt (${pct}%)</div></div>` : ''}
    ${t.note ? `<div class="text-muted" style="white-space:pre-wrap;line-height:1.5;max-height:100px;overflow:hidden;">${escapeHtml(t.note)}</div>` : ''}
    <div class="actions">
      <button class="done-btn">${isDone ? 'Unerledigt' : 'Erledigt'}</button>
      <button class="edit-btn">Bearbeiten</button>
      <button class="reschedule-btn" title="Intelligent neu planen">🗓️</button>
      <button class="draft-btn" title="KI-Entwurf erstellen">✨</button>
      <button class="delete-btn">🗑️</button>
    </div>`;
  card.querySelector('.done-btn').onclick=async ()=>{ t.done=!isDone; t.subs?.forEach(s=>s.done=t.done); t.completedAt=t.done?new Date().toISOString():null; await idbPut(t); upsertLocal(t); scheduleRender(); };
  card.querySelector('.edit-btn').onclick=()=>openModal(t);
  card.querySelector('.reschedule-btn').onclick=()=>handleAiReschedule(t);
  card.querySelector('.draft-btn').onclick= async (e) => { const btn = e.currentTarget; btn.disabled = true; btn.innerHTML = '<span class="spinner"></span>'; await handleAiDraft(t.id); };
  card.querySelector('.delete-btn').onclick=async ()=>{ if(confirm(`Möchtest du "${t.title}" wirklich löschen?`)){ lastDeleted=t; await idbDelete(t.id); removeLocal(t.id); scheduleRender(); showToast('Gelöscht.', true); }};
  card.querySelectorAll('.subtasks input[type=checkbox]').forEach(cb => cb.onchange=async ()=>{ t.subs[cb.dataset.idx].done=cb.checked; await idbPut(t); upsertLocal(t); scheduleRender(); });
  enableDnDForCard(card, t);
  return card;
}

function renderCal(){
  const grid = $('#calGrid'); grid.innerHTML='';
  const m = clamp(Number($('#calMonth').value),0,11), y = Number($('#calYear').value);
  const tasks = applyFilters(true);
  const {days, kw} = monthMatrix(y,m);
  for(let r=0;r<6;r++){
    grid.insertAdjacentHTML('beforeend', `<div class="cal-kw">KW ${kw[r]}</div>`);
    for(let c=0;c<7;c++){
      const d = days[r*7+c];
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const ds = `${yyyy}-${mm}-${dd}`;

      const cell=document.createElement('div'); cell.className='cal-cell';
      if(d.getMonth()!==m) cell.style.opacity=.55;
      cell.innerHTML = `<div class="d">${String(d.getDate()).padStart(2,'0')}</div>`;
      const todays = tasks.filter(t=>t.due===ds);
      todays.slice(0,4).forEach(t=>{
        const chip=document.createElement('div'); chip.className='chip';
        chip.innerHTML = `<span class="ampel ${ampelClass(t.due, t.time)}"></span>${escapeHtml(t.title)}`;
        chip.onclick = () => openCalendarDetailModal(t.id);
        cell.appendChild(chip);
      });
      if(todays.length > 4) cell.insertAdjacentHTML('beforeend', `<div class="chip">+${todays.length - 4} weitere</div>`);
      grid.appendChild(cell);
    }
  }
}

/* ========== Modal & Dropdowns ========== */
function openModal(task=null){
  $('#modalBack').style.display='flex';
  $('#modalTitle').textContent = task?.id ?'Aufgabe bearbeiten':'Neue Aufgabe';
  $('#f_title').value = task?.title || '';
  $('#f_due').value = task?.due || '';
  $('#f_time').value = task?.time || '';
  $('#f_loc').value = task?.loc || '';
  populateListSelect(task?.list||'');
  populateProjectSelect(task?.project||'');
  $('#f_pri').value = task?.pri || 'mid';
  $('#f_note').value = task?.note || '';
  $('#f_subs').value = (task?.subs||[]).map(s => `- ${s.text}`).join('\n');
  $('#saveBtn').onclick = async ()=>{
    const isNew = !task?.id;
    const t = isNew ? { id:uid(), createdAt:new Date().toISOString(), done:false } : { ...STATE.tasks.find(x => x.id === task.id) };
    t.title = $('#f_title').value.trim() || 'Ohne Titel';
    t.due = $('#f_due').value || null;
    t.time = $('#f_time').value || '';
    t.loc = $('#f_loc').value.trim() || '';
    let listSel = $('#f_list').value;
    if(listSel==='__new__'){ const nl = ($('#f_list_new').value||'').trim(); t.list = nl || 'Allgemein'; await maybeAddList(t.list); }
    else { t.list = listSel || 'Allgemein'; }
    let projectSel = $('#f_project').value;
    if(projectSel==='__new__'){ const np = ($('#f_project_new').value||'').trim(); t.project = np || ''; await maybeAddProject(t.project); }
    else { t.project = projectSel || ''; }
    t.pri = $('#f_pri').value;
    t.note = $('#f_note').value.trim();
    t.subs = $('#f_subs').value.split('\n').map(s=>s.trim().replace(/^- /,'')).filter(Boolean).map(line=>({text:line, done:false}));
    if(isNew) t.sortIndex = (STATE.tasks.filter(x=> (x.list||'Allgemein')===t.list).reduce((m,x)=> Math.max(m, x.sortIndex ?? -1), -1)) + 1;
    await idbPut(t);
    upsertLocal(t);
    closeModal();
    scheduleRender();
    showToast('Gespeichert');
  };
}
function closeModal(){ $('#modalBack').style.display='none'; }

function populateProjectSelect(current=''){
  const sel = $('#f_project'); sel.innerHTML='<option value="">— kein Projekt —</option>';
  STATE.projects.forEach(p=>{ const o=document.createElement('option'); o.value=p; o.textContent=p; sel.appendChild(o); });
  sel.insertAdjacentHTML('beforeend', '<option value="__new__">Neues Projekt…</option>');
  sel.value = STATE.projects.includes(current)? current : (current ? '__new__' : '');
  $('#newProjectWrap').style.display = (sel.value==='__new__') ? 'block' : 'none';
  $('#f_project_new').value = (sel.value==='__new__') ? current : '';
  sel.onchange = ()=>{ $('#newProjectWrap').style.display = (sel.value==='__new__') ? 'block' : 'none'; };
}
function populateListSelect(current=''){
  const sel = $('#f_list'); sel.innerHTML='';
  [...new Set(['Allgemein', ...STATE.lists])].forEach(l=>{ const o=document.createElement('option'); o.value=l; o.textContent=l; sel.appendChild(o); });
  sel.insertAdjacentHTML('beforeend', '<option value="__new__">Neue Liste…</option>');
  sel.value = [...STATE.lists, 'Allgemein'].includes(current)? current : (current ? '__new__' : 'Allgemein');
  $('#newListWrap').style.display = (sel.value==='__new__') ? 'block' : 'none';
  $('#f_list_new').value = (sel.value==='__new__') ? current : '';
  sel.onchange = ()=>{ $('#newListWrap').style.display = (sel.value==='__new__') ? 'block' : 'none'; };
}

/* ========== Calendar Detail Modal Functions ========== */
function openCalendarDetailModal(taskId) {
    const task = STATE.tasks.find(t => t.id === taskId);
    if (!task) return;
    const content = $('#calDetailContent');
    content.innerHTML = `
        <h3>${escapeHtml(task.title)}</h3>
        <div class="detail-grid">
            <strong>Fällig:</strong>         <span>${formatDate(task.due, task.time, {weekday: undefined})}</span>
            <strong>Priorität:</strong>    <span class="badge ${task.pri==='high'?'pri-high':task.pri==='low'?'pri-low':'pri-mid'}">${task.pri||'Mittel'}</span>
            ${task.loc ? `<strong>Ort:</strong><span>${escapeHtml(task.loc)}</span>` : ''}
            ${task.list ? `<strong>Liste:</strong><span>${escapeHtml(task.list)}</span>` : ''}
            ${task.project ? `<strong>Projekt:</strong><span>${escapeHtml(task.project)}</span>` : ''}
        </div>
    `;
    if (task.subs?.length) {
        const subsHtml = task.subs.map(s => `<label class="subitem"><input type="checkbox" ${s.done ? 'checked' : ''} disabled><span>${escapeHtml(s.text)}</span></label>`).join('');
        content.insertAdjacentHTML('beforeend', `<div class="detail-subs" style="margin-top:12px"><h4>Checkliste</h4>${subsHtml}</div>`);
    }
    if (task.note) content.insertAdjacentHTML('beforeend', `<div class="detail-note" style="margin-top:12px">${escapeHtml(task.note)}</div>`);
    $('#calDetailEditBtn').onclick = () => { closeCalendarDetailModal(); openModal(task); };
    $('#calDetailModalBack').style.display = 'flex';
}
function closeCalendarDetailModal() { $('#calDetailModalBack').style.display = 'none'; }


/* ========== Management Functions ========== */
function openManageModal() {
    const listContainer = $('#manageListsContainer'), projectContainer = $('#manageProjectsContainer');
    listContainer.innerHTML = ''; projectContainer.innerHTML = '';
    STATE.lists.forEach(name => listContainer.appendChild(createManageItem(name, 'list')));
    STATE.projects.forEach(name => projectContainer.appendChild(createManageItem(name, 'project')));
    $('#manageModalBack').style.display = 'flex';
}
function closeManageModal() { $('#manageModalBack').style.display = 'none'; }
function createManageItem(name, type) {
    const item = document.createElement('div'); item.className = 'manage-item';
    item.innerHTML = `<span>${escapeHtml(name)}</span><div class="actions"><button class="rename-btn" title="Umbenennen">✏️</button><button class="delete-btn" title="Löschen">🗑️</button></div>`;
    item.querySelector('.rename-btn').onclick = () => (type === 'list' ? handleRenameList(name) : handleRenameProject(name));
    item.querySelector('.delete-btn').onclick = () => (type === 'list' ? handleDeleteList(name) : handleDeleteProject(name));
    return item;
}
async function handleRenameList(oldName) {
    const newName = prompt(`Neuer Name für Liste "${oldName}":`, oldName);
    if (!newName || newName.trim() === '' || newName === oldName || newName === 'Allgemein') return;
    if (STATE.lists.includes(newName)) { showToast('Listenname existiert bereits.'); return; }
    STATE.tasks.filter(t => t.list === oldName).forEach(t => t.list = newName);
    STATE.lists = STATE.lists.map(l => l === oldName ? newName : l).sort((a,b)=>a.localeCompare(b));
    await idbBulkPut(STATE.tasks.filter(t => t.list === newName));
    await metaPut('lists', STATE.lists);
    refreshUiAfterManagement();
}
async function handleDeleteList(name) {
    if (!confirm(`Liste "${name}" löschen? Aufgaben werden nach "Allgemein" verschoben.`)) return;
    STATE.tasks.filter(t => t.list === name).forEach(t => t.list = 'Allgemein');
    STATE.lists = STATE.lists.filter(l => l !== name);
    await idbBulkPut(STATE.tasks.filter(t => t.list === 'Allgemein'));
    await metaPut('lists', STATE.lists);
    refreshUiAfterManagement();
}
async function handleRenameProject(oldName) {
    const newName = prompt(`Neuer Name für Projekt "${oldName}":`, oldName);
    if (!newName || newName.trim() === '' || newName === oldName) return;
    if (STATE.projects.includes(newName)) { showToast('Projektname existiert bereits.'); return; }
    STATE.tasks.filter(t => t.project === oldName).forEach(t => t.project = newName);
    STATE.projects = STATE.projects.map(p => p === oldName ? newName : p).sort((a,b)=>a.localeCompare(b));
    await idbBulkPut(STATE.tasks.filter(t => t.project === newName));
    await metaPut('projects', STATE.projects);
    refreshUiAfterManagement();
}
async function handleDeleteProject(name) {
    if (!confirm(`Projekt "${name}" löschen? Projektzuordnung wird von Aufgaben entfernt.`)) return;
    STATE.tasks.filter(t => t.project === name).forEach(t => t.project = '');
    STATE.projects = STATE.projects.filter(p => p !== name);
    await idbBulkPut(STATE.tasks.filter(t => t.project === ''));
    await metaPut('projects', STATE.projects);
    refreshUiAfterManagement();
}
function refreshUiAfterManagement() {
    refreshListFilter();
    refreshProjectFilter();
    scheduleRender();
    openManageModal();
}

/* ========== Projects & Lists (Persistence) ========== */
async function loadProjects(){ STATE.projects = (await metaGet('projects', [])).value || []; refreshProjectFilter(); }
async function loadLists(){ STATE.lists = (await metaGet('lists', [])).value || []; refreshListFilter(); }
async function maybeAddProject(name){ if(name && !STATE.projects.includes(name)){ STATE.projects.push(name); STATE.projects.sort(); await metaPut('projects', STATE.projects); refreshProjectFilter(); } }
async function maybeAddList(name){ if(name && name !== 'Allgemein' && !STATE.lists.includes(name)){ STATE.lists.push(name); STATE.lists.sort(); await metaPut('lists', STATE.lists); refreshListFilter(); } }
function refreshProjectFilter(){ const pf = $('#projectFilter'), cur = pf.value || ''; pf.innerHTML = '<option value="">Alle Projekte</option>'; STATE.projects.forEach(p=>pf.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`)); pf.value = STATE.projects.includes(cur) ? cur : ""; }
function refreshListFilter(){ const lf = $('#listFilter'), cur = lf.value || ''; lf.innerHTML = '<option value="">Alle Listen</option><option value="Allgemein">Allgemein</option>'; STATE.lists.forEach(l=>lf.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`)); lf.value = [...STATE.lists, 'Allgemein'].includes(cur) ? cur : ""; }

/* ========== Toast & Rendering ========== */
function showToast(msg, withUndo=false){
  const t=$('#toast'); t.innerHTML= `<span>${escapeHtml(msg)}</span>`;
  if(withUndo){
    const b=document.createElement('button'); b.textContent='Rückgängig';
    b.onclick=async ()=>{ if(lastDeleted){ await idbPut(lastDeleted); upsertLocal(lastDeleted); lastDeleted=null; scheduleRender(); } hideToast(); };
    t.appendChild(b);
  }
  t.style.display='flex';
  clearTimeout(showToast._h);
  showToast._h=setTimeout(hideToast, 4000);
}
function hideToast(){ $('#toast').style.display='none'; }

function setView(v){ STATE.view=v; $$('#viewTabs button').forEach(b=>b.classList.toggle('active', b.dataset.view===v)); scheduleRender(); }
let renderTimeout;
function scheduleRender(){ clearTimeout(renderTimeout); renderTimeout=setTimeout(render, 16); }
function render(){
  $('#boardView').style.display = STATE.view==='board'?'block':'none';
  $('#calView').style.display = STATE.view==='cal'?'block':'none';
  if(STATE.view==='board') renderBoard();
  if(STATE.view==='cal') renderCal();
}

/* ========== Local state helpers ========== */
function upsertLocal(task){ const i=STATE.tasks.findIndex(x=>x.id===task.id); if(i>-1) STATE.tasks[i]=task; else STATE.tasks.push(task); }
function removeLocal(id){ STATE.tasks = STATE.tasks.filter(t=>t.id!==id); }

/* ========== Init & Listeners ========== */
async function loadAll(){ STATE.tasks = await idbAll(); scheduleRender(); }
function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }

async function toggleButtonSpinner(buttonId, show) {
    const button = $(buttonId); if (!button) return;
    const spinner = button.querySelector('.spinner'), icon = button.querySelector('svg');
    button.disabled = show;
    if (spinner) spinner.classList.toggle('hidden', !show);
    if (icon) icon.classList.toggle('hidden', show);
}

/* ================================================= */
/* ========== ADVANCED AI FEATURE HANDLERS ========= */
/* ================================================= */
async function handleAiTaskCreation() {
    const input = $('#aiTaskInput'), text = input.value.trim(); if (!text) return;
    const button = $('#aiTaskBtn'); button.disabled = true; button.innerHTML = `<span class="spinner"></span> Erstelle...`;
    
    // FIXED: Improved prompt for better title extraction
    const prompt = `Analysiere den To-Do-Eintrag: "${text}". Extrahiere die Daten ins JSON-Format.
    Regeln für den Titel: Formuliere einen kurzen Titel, der die Hauptaktion und das Kernthema enthält. Beispiel: aus "E-Mail an Lara wegen Marketing" wird "E-Mail an Lara / Marketing". Lass keine wichtigen Aktionen oder Personen weg.
    Kontext: Heute ist der ${todayStr()}. Verfügbare Listen: ${['Allgemein',...STATE.lists].join(', ')}. Projekte: ${STATE.projects.join(', ')}.
    JSON-Struktur: {"title": "string", "due": "YYYY-MM-DD", "time": "HH:MM", "loc": "string", "note": "string", "list": {"name": "string", "isNew": boolean}, "project": {"name": "string", "isNew": boolean}}`;
    
    const result = await AI.call(prompt, true);
    if (result) {
        let taskData = { title: result.title || text, due: result.due, time: result.time, loc: result.loc, note: result.note };
        if (result.list?.name) { if (result.list.isNew) await maybeAddList(result.list.name); taskData.list = result.list.name; }
        if (result.project?.name) { if (result.project.isNew) await maybeAddProject(result.project.name); taskData.project = result.project.name; }
        openModal(taskData); input.value = '';
    } else showToast('Konnte Aufgabe nicht erstellen.');
    button.disabled = false; button.textContent = 'Erstellen';
}

async function handleAiDraft(taskId) {
    const task = STATE.tasks.find(t => t.id === taskId); if (!task) return;
    const prompt = `Erstelle einen Textentwurf für: "${task.title}". Berücksichtige Checkliste: ${task.subs?.map(s => s.text).join(', ') || 'keine'}.`;
    const result = await AI.call(prompt, false);
    if (result) {
        task.note = result; await idbPut(task); upsertLocal(task);
        scheduleRender(); showToast('Entwurf erstellt.');
    } else { showToast('Entwurf fehlgeschlagen.'); scheduleRender(); }
}

async function handleAiSubtaskSuggestion() {
    const title = $('#f_title').value.trim(); if (!title) { showToast('Bitte Titel eingeben.'); return; }
    await toggleButtonSpinner('#aiSubtaskBtn', true);
    const prompt = `Erstelle eine Checkliste (max. 2-3 kurze Punkte) für: "${title}". Gib einen String zurück, jeder Punkt mit '-' beginnend und durch Zeilenumbruch getrennt. Beispiel:\n- Punkt 1\n- Punkt 2`;
    const result = await AI.call(prompt, false);
    if (result) $('#f_subs').value = result; else showToast('Keine Vorschläge generiert.');
    await toggleButtonSpinner('#aiSubtaskBtn', false);
}
//... other AI handlers ...
async function handleAiPrioritySuggestion() {
    const title = $('#f_title').value.trim(); if (!title) { showToast('Bitte Titel eingeben.'); return; }
    await toggleButtonSpinner('#aiPriorityBtn', true);
    const result = await AI.call(`Analysiere Dringlichkeit/Wichtigkeit für: "${title}". Antworte NUR mit "high", "mid", oder "low".`, false);
    if (result && ['high', 'mid', 'low'].includes(result.toLowerCase().trim())) $('#f_pri').value = result.toLowerCase().trim(); else showToast('Keine Priorität vorgeschlagen.');
    await toggleButtonSpinner('#aiPriorityBtn', false);
}
async function handleAiCategorySuggestion() {
    const title = $('#f_title').value.trim(); if (!title) { showToast('Bitte Titel eingeben.'); return; }
    await toggleButtonSpinner('#aiCategoryBtn', true);
    const result = await AI.call(`Schlage passende Liste/Projekt für "${title}" vor. Listen: ${['Allgemein', ...STATE.lists].join(', ')}. Projekte: ${STATE.projects.join(', ')}. JSON: {"list": "string", "project": "string"}.`, true);
    if (result) {
        if (result.list && [...STATE.lists, 'Allgemein'].includes(result.list)) $('#f_list').value = result.list;
        if (result.project && STATE.projects.includes(result.project)) $('#f_project').value = result.project;
    } else showToast('Keine Kategorien vorgeschlagen.');
    await toggleButtonSpinner('#aiCategoryBtn', false);
}
async function handleDailyBriefing() {
    const tasks = STATE.tasks.filter(t => !t.done && t.due && t.due <= todayStr());
    if (tasks.length === 0) { showToast("Keine fälligen Aufgaben."); return; }
    const modal = $('#briefingModalBack'); modal.style.display = 'flex';
    const content = $('#briefingContent'); content.innerHTML = '<span class="spinner"></span>';
    const taskList = tasks.map(t => `- ${t.title} (Prio: ${t.pri})`).join('\n');
    const result = await AI.call(`Erstelle ein kurzes Tages-Briefing für den ${new Date().toLocaleDateString('de-DE')}. Aufgaben:\n${taskList}`, false);
    content.textContent = result || "Konnte kein Briefing erstellen.";
}
async function handleAiReschedule(task) {
    const modal = $('#rescheduleModalBack'); modal.style.display = 'flex';
    $('#rescheduleTaskTitle').textContent = `Vorschläge für: "${task.title}"`;
    const suggestionsContainer = $('#rescheduleSuggestions'); suggestionsContainer.innerHTML = '<span class="spinner"></span>';
    const otherTasks = STATE.tasks.filter(t => t.id !== task.id && t.due).map(t => `- ${t.title} am ${t.due}`).join('\n');
    const result = await AI.call(`Aufgabe "${task.title}" (fällig ${task.due}) verschieben. Andere Termine:\n${otherTasks||'Keine'}. Schlage 3 konfliktfreie Termine vor. JSON: [{"due": "YYYY-MM-DD", "time": "HH:MM", "reason": "string"}]`, true);
    suggestionsContainer.innerHTML = ''; 
    if (result?.length) result.forEach(s => {
        const div = document.createElement('div');
        div.innerHTML = `<span><strong>${formatDate(s.due, s.time)}</strong><br><small>${escapeHtml(s.reason)}</small></span><button class="primary">Annehmen</button>`;
        div.querySelector('button').onclick = async () => { task.due = s.due; task.time = s.time; await idbPut(task); upsertLocal(task); scheduleRender(); modal.style.display = 'none'; showToast('Termin verschoben!'); };
        suggestionsContainer.appendChild(div);
    }); else suggestionsContainer.textContent = 'Keine Vorschläge gefunden.';
}
async function handleAiSmartSort(listName) {
    const tasks = STATE.tasks.filter(t => (t.list || 'Allgemein') === listName && !t.done);
    if (tasks.length < 2) { showToast('Nicht genügend Aufgaben zum Sortieren.'); return; }
    const result = await AI.call(`Sortiere diese Aufgabenliste am effektivsten: ${JSON.stringify(tasks.map(t=>({id:t.id,title:t.title,due:t.due,pri:t.pri})))}. Gib NUR ein JSON-Array der geordneten IDs zurück.`, true);
    if (result?.length) {
        await idbBulkPut(result.map((taskId, i) => { const task=STATE.tasks.find(t=>t.id===taskId); if(task){task.sortIndex=i; upsertLocal(task); return task;} }).filter(Boolean));
        scheduleRender(); showToast(`Liste "${listName}" neu sortiert.`);
    } else showToast('Sortierung fehlgeschlagen.');
}
// REMOVED: handleDailySummary function was here.

(async function init(){
  await idbOpen();
  const s = await metaGet('settings', {}); STATE.settings = s.value||{};
  STATE.filter.onlyOpen = STATE.settings.onlyOpen ?? true;
  $('#onlyOpen').checked = STATE.filter.onlyOpen;
  await loadProjects(); await loadLists(); await AI.loadApiKey();

  const t = new Date();
  $('#calYear').value=t.getFullYear();
  const cm=$('#calMonth');
  for(let i=0;i<12;i++) cm.insertAdjacentHTML('beforeend', `<option value="${i}">${new Date(2000,i,1).toLocaleString('de-DE',{month:'long'})}</option>`);
  cm.value=t.getMonth();

  // Modal Listeners
  $('#addBtn').onclick=()=>openModal();
  $('#cancelBtn').onclick=()=>closeModal();
  $('#closeModalBtn').onclick=()=>closeModal();
  $('#closeRescheduleBtn').onclick = () => $('#rescheduleModalBack').style.display = 'none';
  $('#closeBriefingBtn').onclick = () => $('#briefingModalBack').style.display = 'none';
  $('#calDetailCloseBtn').onclick = closeCalendarDetailModal;
  $('#manageCloseBtn').onclick = closeManageModal;
  $('#manageBtn').onclick = openManageModal;

  // Filter & View Listeners
  $('#q').oninput=e=>{ STATE.filter.q=e.target.value; scheduleRender(); };
  $('#onlyOpen').onchange=e=>{ STATE.filter.onlyOpen=e.target.checked; STATE.settings.onlyOpen = e.target.checked; metaPut('settings', STATE.settings); scheduleRender(); };
  $('#showClosedLists').onchange=e=>{ STATE.filter.showClosedLists=e.target.checked; scheduleRender(); };
  $('#projectFilter').onchange=e=>{ STATE.filter.project=e.target.value; scheduleRender(); };
  $('#listFilter').onchange=e=>{ STATE.filter.list=e.target.value; scheduleRender(); };
  $$('#viewTabs button').forEach(b=> b.onclick=()=>setView(b.dataset.view));
  $('#calToday').onclick=()=>{ const n=new Date(); $('#calMonth').value=n.getMonth(); $('#calYear').value=n.getFullYear(); scheduleRender(); };
  $('#calMonth').onchange=()=>scheduleRender();
  $('#calYear').onchange=()=>scheduleRender();

  // AI Listeners
  $('#setApiKeyBtn').onclick = () => AI.getApiKey();
  $('#aiTaskBtn').onclick = handleAiTaskCreation;
  $('#aiTaskInput').onkeydown = (e) => { if (e.key === 'Enter') handleAiTaskCreation(); };
  $('#aiSubtaskBtn').onclick = handleAiSubtaskSuggestion;
  $('#aiPriorityBtn').onclick = handleAiPrioritySuggestion;
  $('#aiCategoryBtn').onclick = handleAiCategorySuggestion;
  $('#aiBriefingBtn').onclick = handleDailyBriefing;
  // REMOVED: Event listener for aiSummaryBtn was here.

  await loadAll();

  if(STATE.tasks.length===0){
    const example = { id:uid(), title:'Beispiel: App erkunden', list:'Allgemein', due: todayStr(), pri:'high', subs:[{text:'Neue Aufgabe mit KI erstellen',done:false},{text:'Listen & Projekte verwalten',done:false}], createdAt:new Date().toISOString(), done:false, sortIndex:0 };
    await idbPut(example); upsertLocal(example);
    scheduleRender(); showToast('Willkommen! Beispielaufgabe angelegt.');
  }

  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) scheduleRender(); });
})();
</script>
</body>
</html>
